<!-- 管理后台留言管理 -->
<div class="admin-dashboard">
    <!-- 侧边栏 -->
    <div class="admin-sidebar">
        <div class="sidebar-header">
            <h3>管理后台</h3>
        </div>
        <div class="sidebar-menu">
            <ul>
                <li>
                    <a href="/admin/dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>控制台</span>
                    </a>
                </li>
                <li>
                    <a href="/admin/pages">
                        <i class="fas fa-file-alt"></i>
                        <span>页面管理</span>
                    </a>
                </li>
                <li class="active">
                    <a href="/admin/messages">
                        <i class="fas fa-envelope"></i>
                        <span>留言管理</span>
                    </a>
                </li>
                <li>
                    <a href="/admin/settings">
                        <i class="fas fa-cog"></i>
                        <span>网站设置</span>
                    </a>
                </li>
                <li class="logout">
                    <a href="/admin/logout">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>退出登录</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- 主内容区 -->
    <div class="admin-main">
        <!-- 顶部导航 -->
        <div class="admin-header">
            <div class="header-left">
                <button id="sidebarToggle" class="sidebar-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h2>留言管理</h2>
            </div>
            <div class="header-right">
                <div class="admin-user">
                    <img src="/images/admin-avatar.png" alt="管理员头像" class="admin-avatar">
                    <span class="admin-name"><%= username %></span>
                </div>
            </div>
        </div>

        <!-- 内容区域 -->
        <div class="admin-content">
            <!-- 提示消息 -->
            <% if (typeof success !== 'undefined' && success) { %>
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    <p>操作成功！</p>
                </div>
            <% } %>
            
            <% if (typeof error !== 'undefined' && error) { %>
                <div class="alert alert-error">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>操作失败，请稍后再试。</p>
                </div>
            <% } %>
            
            <!-- 操作栏 -->
            <div class="action-bar">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="搜索留言...">
                    <button><i class="fas fa-search"></i></button>
                </div>
                <div class="filter-options">
                    <select class="filter-select" id="statusFilter">
                        <option value="all">所有留言</option>
                        <option value="new">未读留言</option>
                        <option value="read">已读留言</option>
                        <option value="replied">已回复</option>
                    </select>
                </div>
            </div>

            <!-- 留言列表 -->
            <div class="message-list-container">
                <% if (contacts && contacts.length > 0) { %>
                    <% contacts.forEach(contact => { %>
                        <div class="message-item" data-id="<%= contact.id %>" data-status="<%= contact.status || 'new' %>">
                            <div class="message-header">
                                <div class="message-info">
                                    <div class="message-avatar">
                                        <span><%= contact.name.charAt(0) %></span>
                                    </div>
                                    <div class="message-meta">
                                        <h3><%= contact.name %></h3>
                                        <div class="message-details">
                                            <span class="message-email"><%= contact.email %></span>
                                            <span class="message-phone"><%= contact.phone %></span>
                                            <span class="message-date"><%= new Date(contact.date).toLocaleString('zh-CN') %></span>
                                            <span class="message-subject"><%= contact.subject %></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="message-status">
                                    <% let statusClass = 'new'; %>
                                    <% let statusText = '未读'; %>
                                    
                                    <% if (contact.status === 'read') { %>
                                        <% statusClass = 'read'; %>
                                        <% statusText = '已读'; %>
                                    <% } else if (contact.status === 'replied') { %>
                                        <% statusClass = 'replied'; %>
                                        <% statusText = '已回复'; %>
                                    <% } %>
                                    
                                    <span class="status-badge <%= statusClass %>"><%= statusText %></span>
                                </div>
                            </div>
                            <div class="message-content">
                                <p><%= contact.message %></p>
                            </div>
                            <div class="message-actions">
                                <% if (contact.status === 'new') { %>
                                    <button class="btn-mark-read" data-id="<%= contact.id %>">
                                        <i class="fas fa-check"></i> 标记为已读
                                    </button>
                                <% } else if (contact.status === 'read') { %>
                                    <button class="btn-mark-replied" data-id="<%= contact.id %>">
                                        <i class="fas fa-reply"></i> 标记为已回复
                                    </button>
                                <% } %>
                                
                                <button class="btn-delete" data-id="<%= contact.id %>">
                                    <i class="fas fa-trash"></i> 删除
                                </button>
                            </div>
                        </div>
                    <% }); %>
                <% } else { %>
                    <div class="no-messages">
                        <i class="fas fa-inbox"></i>
                        <p>暂无留言记录</p>
                    </div>
                <% } %>
            </div>
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal" id="deleteModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>确认删除</h3>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <p>确定要删除这条留言吗？此操作无法撤销。</p>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel">取消</button>
            <form id="deleteForm" method="POST">
                <button type="submit" class="btn-confirm">确认删除</button>
            </form>
        </div>
    </div>
</div>

<style>
    /* 管理后台全局样式 */
    .admin-dashboard {
        display: flex;
        min-height: 100vh;
        background-color: #f5f7fa;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* 侧边栏样式 */
    .admin-sidebar {
        width: 250px;
        background-color: #2c3e50;
        color: #ecf0f1;
        transition: all 0.3s;
    }

    .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid #34495e;
    }

    .sidebar-header h3 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
    }

    .sidebar-menu ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .sidebar-menu li {
        margin: 0;
        padding: 0;
    }

    .sidebar-menu li a {
        display: block;
        padding: 15px 20px;
        color: #ecf0f1;
        text-decoration: none;
        transition: all 0.3s;
    }

    .sidebar-menu li a:hover {
        background-color: #34495e;
    }

    .sidebar-menu li.active a {
        background-color: #3498db;
        color: #fff;
    }

    .sidebar-menu li i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
    }

    .sidebar-menu li.logout {
        margin-top: 30px;
        border-top: 1px solid #34495e;
    }

    .sidebar-menu li.logout a {
        color: #e74c3c;
    }

    .sidebar-menu li.logout a:hover {
        background-color: #e74c3c;
        color: #fff;
    }

    /* 主内容区样式 */
    .admin-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow-x: hidden;
    }

    .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 30px;
        background-color: #fff;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .header-left {
        display: flex;
        align-items: center;
    }

    .header-left h2 {
        margin: 0;
        margin-left: 15px;
        font-size: 22px;
        font-weight: 600;
        color: #2c3e50;
    }

    .sidebar-toggle {
        background: none;
        border: none;
        font-size: 20px;
        color: #2c3e50;
        cursor: pointer;
    }

    .admin-user {
        display: flex;
        align-items: center;
    }

    .admin-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
    }

    .admin-name {
        font-weight: 500;
        color: #2c3e50;
    }

    .admin-content {
        flex: 1;
        padding: 30px;
        overflow-y: auto;
    }

    /* 留言管理样式 */
    .action-bar {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .search-box {
        display: flex;
        width: 300px;
    }

    .search-box input {
        flex: 1;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-right: none;
        border-radius: 4px 0 0 4px;
        font-size: 14px;
    }

    .search-box button {
        padding: 10px 15px;
        background-color: #3498db;
        color: #fff;
        border: none;
        border-radius: 0 4px 4px 0;
        cursor: pointer;
    }

    .filter-select {
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        background-color: #fff;
    }

    .message-list-container {
        margin-bottom: 30px;
    }

    .message-item {
        background-color: #fff;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
        overflow: hidden;
    }

    .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #f1f1f1;
    }

    .message-info {
        display: flex;
        align-items: center;
    }

    .message-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: #3498db;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: 600;
        margin-right: 15px;
    }

    .message-meta h3 {
        margin: 0 0 5px 0;
        font-size: 18px;
        font-weight: 600;
        color: #2c3e50;
    }

    .message-details {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        font-size: 14px;
        color: #7f8c8d;
    }

    .message-content {
        padding: 20px;
        font-size: 16px;
        line-height: 1.6;
        color: #34495e;
    }

    .message-actions {
        display: flex;
        padding: 0 20px 20px;
        gap: 10px;
    }

    .message-actions button {
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        transition: all 0.3s;
    }

    .message-actions button i {
        margin-right: 5px;
    }

    .btn-mark-read, .btn-mark-replied {
        background-color: #2ecc71;
        color: #fff;
    }

    .btn-mark-read:hover, .btn-mark-replied:hover {
        background-color: #27ae60;
    }

    .btn-mark-unread {
        background-color: #f39c12;
        color: #fff;
    }

    .btn-mark-unread:hover {
        background-color: #d35400;
    }

    .btn-delete {
        background-color: #e74c3c;
        color: #fff;
    }

    .btn-delete:hover {
        background-color: #c0392b;
    }

    .status-badge {
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 500;
    }

    .status-badge.new {
        background-color: #f39c12;
        color: #fff;
    }

    .status-badge.read {
        background-color: #3498db;
        color: #fff;
    }

    .status-badge.replied {
        background-color: #2ecc71;
        color: #fff;
    }

    .no-messages {
        text-align: center;
        padding: 50px 0;
        color: #7f8c8d;
    }

    .no-messages i {
        font-size: 50px;
        margin-bottom: 20px;
    }

    /* 提示消息样式 */
    .alert {
        padding: 15px 20px;
        margin-bottom: 30px;
        border-radius: 5px;
        display: flex;
        align-items: center;
        transition: opacity 0.5s ease;
    }

    .alert i {
        font-size: 24px;
        margin-right: 15px;
    }

    .alert p {
        margin: 0;
        font-size: 16px;
    }

    .alert-success {
        background-color: #d4edda;
        color: #155724;
        border-left: 5px solid #28a745;
    }

    .alert-error {
        background-color: #f8d7da;
        color: #721c24;
        border-left: 5px solid #dc3545;
    }

    /* 模态框样式 */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        background-color: #fff;
        margin: 15% auto;
        width: 400px;
        border-radius: 5px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
        padding: 15px 20px;
        border-bottom: 1px solid #f1f1f1;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
    }

    .close {
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-footer {
        padding: 15px 20px;
        border-top: 1px solid #f1f1f1;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .modal-footer button {
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
    }

    .btn-cancel {
        background-color: #f1f1f1;
        color: #333;
    }

    .btn-confirm {
        background-color: #e74c3c;
        color: #fff;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 侧边栏切换
        const sidebarToggle = document.getElementById('sidebarToggle');
        const adminSidebar = document.querySelector('.admin-sidebar');
        
        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', function() {
                adminSidebar.classList.toggle('collapsed');
            });
        }
        
        // 搜索功能
        const searchInput = document.getElementById('searchInput');
        const messageItems = document.querySelectorAll('.message-item');
        
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                
                messageItems.forEach(item => {
                    const name = item.querySelector('.message-meta h3').textContent.toLowerCase();
                    const email = item.querySelector('.message-email').textContent.toLowerCase();
                    const content = item.querySelector('.message-content p').textContent.toLowerCase();
                    
                    if (name.includes(searchTerm) || email.includes(searchTerm) || content.includes(searchTerm)) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }
        
        // 状态过滤
        const statusFilter = document.getElementById('statusFilter');
        
        if (statusFilter) {
            statusFilter.addEventListener('change', function() {
                const filterValue = this.value;
                
                messageItems.forEach(item => {
                    const status = item.getAttribute('data-status');
                    
                    if (filterValue === 'all' || status === filterValue) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }
        
        // 标记为已读
        const markReadButtons = document.querySelectorAll('.btn-mark-read');
        
        markReadButtons.forEach(button => {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                
                fetch(`/admin/messages/status/${id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'read' })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        });
        
        // 标记为已回复
        const markRepliedButtons = document.querySelectorAll('.btn-mark-replied');
        
        markRepliedButtons.forEach(button => {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                
                fetch(`/admin/messages/status/${id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'replied' })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        });
        
        // 删除留言
        const deleteModal = document.getElementById('deleteModal');
        const deleteForm = document.getElementById('deleteForm');
        const deleteButtons = document.querySelectorAll('.btn-delete');
        const closeModal = document.querySelector('.close');
        const cancelButton = document.querySelector('.btn-cancel');
        
        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                deleteForm.action = `/admin/messages/delete/${id}`;
                deleteModal.style.display = 'block';
            });
        });
        
        if (closeModal) {
            closeModal.addEventListener('click', function() {
                deleteModal.style.display = 'none';
            });
        }
        
        if (cancelButton) {
            cancelButton.addEventListener('click', function() {
                deleteModal.style.display = 'none';
            });
        }
        
        // 点击模态框外部关闭
        window.addEventListener('click', function(event) {
            if (event.target === deleteModal) {
                deleteModal.style.display = 'none';
            }
        });
        
        // 自动隐藏提示消息
        const alertMessage = document.querySelector('.alert');
        if (alertMessage) {
            setTimeout(() => {
                alertMessage.style.opacity = '0';
                setTimeout(() => {
                    alertMessage.style.display = 'none';
                }, 500);
            }, 3000);
        }
    });
</script> 