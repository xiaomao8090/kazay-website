<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kazay Studio - 管理员登录</title>
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/admin.css">
  <style>
    body {
      background-color: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    .login-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      max-width: 500px;
      width: 100%;
      padding: 30px;
    }
    .login-header {
      text-align: center;
      margin-bottom: 30px;
    }
    .login-header img {
      max-width: 150px;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .btn-primary {
      background-color: #3498db;
      border-color: #3498db;
      width: 100%;
      padding: 10px;
      font-size: 16px;
    }
    .btn-primary:hover {
      background-color: #2980b9;
      border-color: #2980b9;
    }
    .verification-container {
      display: none;
    }
    .alert {
      margin-bottom: 20px;
    }
    .security-info {
      margin-top: 20px;
      font-size: 12px;
      color: #6c757d;
    }
    #loginAttempts {
      color: #dc3545;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="login-header">
      <img src="/images/logo.png" alt="Kazay Studio Logo">
      <h2>管理员登录</h2>
    </div>
    
    <!-- 错误提示 -->
    <div id="errorAlert" class="alert alert-danger" style="display: none;">
      <strong>错误:</strong> <span id="errorMessage"></span>
    </div>
    
    <!-- 成功提示 -->
    <div id="successAlert" class="alert alert-success" style="display: none;">
      <strong>成功:</strong> <span id="successMessage"></span>
    </div>
    
    <!-- 安全提示 -->
    <div id="securityAlert" class="alert alert-warning" style="display: none;">
      <strong>安全提示:</strong> <span id="securityMessage"></span>
    </div>
    
    <!-- 登录表单 -->
    <div id="loginForm">
      <div class="form-group">
        <label for="username">用户名</label>
        <input type="text" class="form-control" id="username" placeholder="请输入用户名" required>
      </div>
      <div class="form-group">
        <label for="password">密码</label>
        <input type="password" class="form-control" id="password" placeholder="请输入密码" required>
      </div>
      <button type="button" class="btn btn-primary" id="loginButton">获取验证码</button>
    </div>
    
    <!-- 验证码表单 -->
    <div id="verificationForm" class="verification-container">
      <h2 class="text-center mb-4">管理后台登录</h2>
      <p class="text-center mb-3">验证码已发送至 <span id="adminEmail" class="font-weight-bold"></span></p>
      <p class="text-center">请输入6位数字验证码完成登录</p>
      
      <div class="d-flex justify-content-center mb-4">
        <input type="text" class="form-control verification-input" maxlength="1" style="width: 50px; height: 50px; text-align: center; margin: 0 5px; font-size: 24px;">
        <input type="text" class="form-control verification-input" maxlength="1" style="width: 50px; height: 50px; text-align: center; margin: 0 5px; font-size: 24px;">
        <input type="text" class="form-control verification-input" maxlength="1" style="width: 50px; height: 50px; text-align: center; margin: 0 5px; font-size: 24px;">
        <input type="text" class="form-control verification-input" maxlength="1" style="width: 50px; height: 50px; text-align: center; margin: 0 5px; font-size: 24px;">
        <input type="text" class="form-control verification-input" maxlength="1" style="width: 50px; height: 50px; text-align: center; margin: 0 5px; font-size: 24px;">
        <input type="text" class="form-control verification-input" maxlength="1" style="width: 50px; height: 50px; text-align: center; margin: 0 5px; font-size: 24px;">
      </div>
      
      <button type="button" class="btn btn-primary" id="verifyButton">登录</button>
      
      <div class="d-flex justify-content-between mt-3">
        <button type="button" class="btn btn-link" id="resendCode">重新发送验证码 (<span id="countdown">26s</span>)</button>
        <button type="button" class="btn btn-link" id="backToLogin">返回</button>
      </div>
      
      <!-- 隐藏的验证码输入字段，用于存储完整验证码 -->
      <input type="hidden" id="verificationCode">
    </div>
    
    <div class="security-info">
      <p>安全提示：</p>
      <ul>
        <li>系统会记录所有登录尝试</li>
        <li>多次失败将触发安全警报</li>
        <li>当前IP的失败尝试次数: <span id="loginAttempts">0</span></li>
        <li>登录成功后，您的IP将被添加到可信列表</li>
      </ul>
    </div>
  </div>

  <script src="/js/jquery-3.6.0.min.js"></script>
  <script>
    let sessionId = '';
    let failedAttempts = 0;
    let countdownInterval;
    let remainingTime = 26;
    
    // 检查URL参数
    function getUrlParameter(name) {
      name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
      var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
      var results = regex.exec(location.search);
      return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }
    
    // 显示错误信息
    function showError(message) {
      $('#errorMessage').text(message);
      $('#errorAlert').fadeIn();
      setTimeout(() => {
        $('#errorAlert').fadeOut();
      }, 5000);
      
      // 更新失败计数
      failedAttempts++;
      $('#loginAttempts').text(failedAttempts);
    }
    
    // 显示成功信息
    function showSuccess(message) {
      $('#successMessage').text(message);
      $('#successAlert').fadeIn();
      setTimeout(() => {
        $('#successAlert').fadeOut();
      }, 3000);
    }
    
    // 如果是登出状态，显示提示
    if (getUrlParameter('logout') === 'true') {
      showSuccess('您已成功退出登录');
    }
    
    // 显示安全提示
    function showSecurityAlert(message) {
      $('#securityMessage').text(message);
      $('#securityAlert').fadeIn();
      setTimeout(() => {
        $('#securityAlert').fadeOut();
      }, 5000);
    }
    
    // 开始倒计时
    function startCountdown() {
      remainingTime = 26;
      $('#countdown').text(remainingTime + 's');
      $('#resendCode').prop('disabled', true);
      
      clearInterval(countdownInterval);
      countdownInterval = setInterval(function() {
        remainingTime--;
        $('#countdown').text(remainingTime + 's');
        
        if (remainingTime <= 0) {
          clearInterval(countdownInterval);
          $('#resendCode').prop('disabled', false);
          $('#countdown').text('0s');
        }
      }, 1000);
    }
    
    // 处理验证码输入
    $(document).on('input', '.verification-input', function() {
      const value = $(this).val();
      
      // 只允许输入数字
      if (value && !/^\d+$/.test(value)) {
        $(this).val('');
        return;
      }
      
      // 如果输入了内容，移动到下一个输入框
      if (value.length === 1) {
        $(this).next('.verification-input').focus();
      }
      
      // 收集所有验证码
      let code = '';
      $('.verification-input').each(function() {
        code += $(this).val();
      });
      
      // 存储完整验证码
      $('#verificationCode').val(code);
      console.log('当前验证码:', code);
      
      // 如果验证码已经输入完整，自动提交
      if (code.length === 6) {
        setTimeout(function() {
          $('#verifyButton').click();
        }, 500);
      }
    });
    
    // 允许在验证码输入框中使用退格键返回上一个输入框
    $(document).on('keydown', '.verification-input', function(e) {
      if (e.keyCode === 8 && $(this).val() === '') {
        $(this).prev('.verification-input').focus();
      }
    });
    
    // 获取验证码
    $('#loginButton').click(function() {
      const username = $('#username').val().trim();
      const password = $('#password').val().trim();
      
      if (!username || !password) {
        showError('请输入用户名和密码');
        return;
      }
      
      // 禁用按钮，防止重复点击
      $('#loginButton').prop('disabled', true).text('处理中...');
      
      // 发送请求
      $.ajax({
        url: '/admin/request-code',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ username, password }),
        success: function(response) {
          if (response.success) {
            // 保存会话ID
            sessionId = response.sessionId;
            
            // 显示验证码表单
            $('#loginForm').hide();
            $('#verificationForm').show();
            
            // 显示管理员邮箱
            $('#adminEmail').text(response.adminEmail);
            
            // 显示成功信息
            showSuccess('验证码已发送，请查收邮件');
            
            // 重置失败计数
            failedAttempts = 0;
            $('#loginAttempts').text(failedAttempts);
            
            // 清空验证码输入框
            $('.verification-input').val('');
            $('#verificationCode').val('');
            
            // 聚焦第一个验证码输入框
            $('.verification-input:first').focus();
            
            // 开始倒计时
            startCountdown();
          } else {
            showError(response.message || '用户名或密码错误');
            $('#loginButton').prop('disabled', false).text('获取验证码');
          }
        },
        error: function(xhr) {
          let errorMsg = '请求失败，请稍后再试';
          try {
            const response = JSON.parse(xhr.responseText);
            if (response && response.message) {
              errorMsg = response.message;
            }
          } catch (e) {}
          
          showError(errorMsg);
          $('#loginButton').prop('disabled', false).text('获取验证码');
        }
      });
    });
    
    // 重新发送验证码
    $('#resendCode').click(function() {
      if ($(this).prop('disabled')) return;
      
      const username = $('#username').val().trim();
      const password = $('#password').val().trim();
      
      // 禁用按钮
      $('#resendCode').prop('disabled', true);
      
      // 发送请求
      $.ajax({
        url: '/admin/request-code',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ username, password }),
        success: function(response) {
          if (response.success) {
            // 保存会话ID
            sessionId = response.sessionId;
            
            // 显示成功信息
            showSuccess('验证码已重新发送，请查收邮件');
            
            // 开始倒计时
            startCountdown();
          } else {
            showError(response.message || '重新发送验证码失败');
            $('#resendCode').prop('disabled', false);
          }
        },
        error: function(xhr) {
          let errorMsg = '请求失败，请稍后再试';
          try {
            const response = JSON.parse(xhr.responseText);
            if (response && response.message) {
              errorMsg = response.message;
            }
          } catch (e) {}
          
          showError(errorMsg);
          $('#resendCode').prop('disabled', false);
        }
      });
    });
    
    // 验证验证码
    $('#verifyButton').click(function() {
      const code = $('#verificationCode').val().trim();
      
      if (!code) {
        showError('请输入验证码');
        return;
      }
      
      if (code.length !== 6 || isNaN(code)) {
        showError('验证码应为6位数字');
        return;
      }
      
      // 禁用按钮，防止重复点击
      $('#verifyButton').prop('disabled', true).text('验证中...');
      
      // 发送请求
      $.ajax({
        url: '/admin/verify-code',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ sessionId, code }),
        success: function(response) {
          if (response.success) {
            showSuccess('验证成功，正在跳转...');
            
            // 跳转到管理后台
            setTimeout(function() {
              window.location.href = '/admin/dashboard';
            }, 1000);
          } else {
            showError(response.message || '验证码错误');
            $('#verifyButton').prop('disabled', false).text('登录');
            
            // 如果会话过期或安全检查失败，返回登录表单
            if (response.errorCode === 'SESSION_EXPIRED' || response.errorCode === 'SESSION_MISMATCH' || response.errorCode === 'SECURITY_CHECK_FAILED') {
              showSecurityAlert('安全验证失败，请重新登录');
              setTimeout(function() {
                $('#verificationForm').hide();
                $('#loginForm').show();
                $('#loginButton').prop('disabled', false).text('获取验证码');
              }, 2000);
            }
          }
        },
        error: function(xhr) {
          let errorMsg = '请求失败，请稍后再试';
          try {
            const response = JSON.parse(xhr.responseText);
            if (response && response.message) {
              errorMsg = response.message;
            }
          } catch (e) {}
          
          showError(errorMsg);
          $('#verifyButton').prop('disabled', false).text('登录');
        }
      });
    });
    
    // 返回登录表单
    $('#backToLogin').click(function() {
      $('#verificationForm').hide();
      $('#loginForm').show();
      $('#loginButton').prop('disabled', false).text('获取验证码');
      clearInterval(countdownInterval);
    });
    
    // 按Enter键提交
    $('#username, #password').keypress(function(e) {
      if (e.which === 13) {
        $('#loginButton').click();
      }
    });
  </script>
</body>
</html> 